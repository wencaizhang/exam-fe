<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>逻辑 | vue开发记录</title>
    <meta name="description" content="Just playing around">
    
    
    <link rel="preload" href="/exam-system-fe/assets/css/0.styles.a5f18ac7.css" as="style"><link rel="preload" href="/exam-system-fe/assets/js/app.03fc6983.js" as="script"><link rel="preload" href="/exam-system-fe/assets/js/5.0eac10a0.js" as="script"><link rel="prefetch" href="/exam-system-fe/assets/js/7.654c407e.js"><link rel="prefetch" href="/exam-system-fe/assets/js/2.6d91d58d.js"><link rel="prefetch" href="/exam-system-fe/assets/js/3.192cc8eb.js"><link rel="prefetch" href="/exam-system-fe/assets/js/4.8e9520a6.js"><link rel="prefetch" href="/exam-system-fe/assets/js/6.425ad29d.js"><link rel="prefetch" href="/exam-system-fe/assets/js/8.9b53ac15.js"><link rel="prefetch" href="/exam-system-fe/assets/js/9.a42ad3b7.js"><link rel="prefetch" href="/exam-system-fe/assets/js/10.9635af37.js"><link rel="prefetch" href="/exam-system-fe/assets/js/11.620036dc.js"><link rel="prefetch" href="/exam-system-fe/assets/js/12.f4f91729.js"><link rel="prefetch" href="/exam-system-fe/assets/js/13.6f806875.js"><link rel="prefetch" href="/exam-system-fe/assets/js/14.3c888593.js"><link rel="prefetch" href="/exam-system-fe/assets/js/15.deec01d9.js"><link rel="prefetch" href="/exam-system-fe/assets/js/16.1adc85dc.js">
    <link rel="stylesheet" href="/exam-system-fe/assets/css/0.styles.a5f18ac7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/exam-system-fe/" class="home-link router-link-active"><!----> <span class="site-name">vue开发记录</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://cn.vuejs.org/v2/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://vuex.vuejs.org/zh/installation.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vuex文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-router
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://cn.vuejs.org/v2/guide/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://vuex.vuejs.org/zh/installation.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vuex文档
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://router.vuejs.org/zh/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  vue-router
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/exam-system-fe/" class="sidebar-link">vue 开发笔记</a></li><li><a href="/exam-system-fe/markdown/01-用户登录状态管理.html" class="active sidebar-link">用户登录状态管理.</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/exam-system-fe/markdown/01-用户登录状态管理.html#逻辑" class="sidebar-link">逻辑</a></li><li class="sidebar-sub-header"><a href="/exam-system-fe/markdown/01-用户登录状态管理.html#储存用户信息方案" class="sidebar-link">储存用户信息方案</a></li><li class="sidebar-sub-header"><a href="/exam-system-fe/markdown/01-用户登录状态管理.html#关于本地储存方案" class="sidebar-link">关于本地储存方案</a></li><li class="sidebar-sub-header"><a href="/exam-system-fe/markdown/01-用户登录状态管理.html#每次页面跳转之前检测权限" class="sidebar-link">每次页面跳转之前检测权限</a></li><li class="sidebar-sub-header"><a href="/exam-system-fe/markdown/01-用户登录状态管理.html#其他" class="sidebar-link">其他</a></li></ul></li><li><a href="/exam-system-fe/markdown/02-设置网页title.html" class="sidebar-link">设置网页title.</a></li><li><a href="/exam-system-fe/markdown/03-样式私有化.html" class="sidebar-link">样式私有化.</a></li><li><a href="/exam-system-fe/markdown/04-vuex状态管理.html" class="sidebar-link">vuex状态管理.</a></li><li><a href="/exam-system-fe/markdown/05-vue全局公用函数.html" class="sidebar-link">vue全局公用函数.</a></li><li><a href="/exam-system-fe/markdown/05-webpack项目开发环境访问时提示：Invalid Host header.html" class="sidebar-link">webpack项目开发环境访问时提示：Invalid Host header.</a></li><li><a href="/exam-system-fe/markdown/06-Vue点击button使input获取焦点.html" class="sidebar-link">Vue 点击 button 使 input 获取焦点.</a></li><li><a href="/exam-system-fe/markdown/07-axios 封装.html" class="sidebar-link">axios 封装.</a></li><li><a href="/exam-system-fe/markdown/08-本地存储数据方案分析.html" class="sidebar-link">本地存储数据方案分析.</a></li><li><a href="/exam-system-fe/markdown/09-vuex 状态持久化.html" class="sidebar-link">vuex 状态持久化</a></li><li><a href="/exam-system-fe/markdown/10-webpack打包优化.html" class="sidebar-link">webpack打包优化.</a></li><li><a href="/exam-system-fe/markdown/11-键盘弹起优化.html" class="sidebar-link">键盘弹起优化.</a></li></ul> </div> <div class="page"> <div class="content"><h2 id="逻辑"><a href="#逻辑" aria-hidden="true" class="header-anchor">#</a> 逻辑</h2> <ol><li>当用户访问站点时，在路由拦截器里判断 <code>cookie</code> 里面是否有 username 或者 token 或者 sessionId 之类的标识，如果有：表示“已登陆”，否则跳转到登陆页面；</li> <li>如果已登陆，跳转到相应路由，对应页面调用 api 获取数据，否则提示&quot;未登陆&quot;，跳转到登陆页；</li> <li>正常登陆，保存用户信息到 <code>cookie</code></li></ol> <h2 id="储存用户信息方案"><a href="#储存用户信息方案" aria-hidden="true" class="header-anchor">#</a> 储存用户信息方案</h2> <p>同时使用 <code>vuex</code> 和 <code>localStorage</code> 储存用户信息</p> <p>最简单的做法就是本地没数据就登录，有数据就刷新，后台判断数据过期了就清除数据再登录。</p> <p>本地储存用户信息是为了避免页面刷新导致数据丢失的问题，</p> <p>为统一管理 app 状态，使用 <code>vuex</code> 储存数据，另外，与在内存中的 <code>state</code> 相比，怕是其他方式都是慢的。</p> <p>使用 <code>vuex</code> 管理状态，但是页面刷新时，<code>state</code> 中的信息就会清空，因此需要同时在本地存储用户信息</p> <h2 id="关于本地储存方案"><a href="#关于本地储存方案" aria-hidden="true" class="header-anchor">#</a> 关于本地储存方案</h2> <p>用户登录成功以后应该在本地保存一份用户数据，注意保存本地的方法有很多种，比如 <code>cookie</code> 、<code>localStorage</code>、<code>indexedDB</code> 等。</p> <p>这里使用的是 <code>localStorage</code>，但是代码中并没有直接调用 <code>window.localStorage</code>，而是封装一个用户数据的读取函数，解除代码耦合，将来要改成其他存储方式比较简单：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getUserinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">setUserinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre></div><p>可以存到 <code>localStorage</code> 里面，只是不能直接用 <code>window.localStorage</code> 相关函数的原因如下：</p> <p>假设一个情景，在前期我们要求把用户信息存储在 <code>localStorage</code> 中，但是后期，我们又不想存在这里，我们希望存在 <code>cookie</code> 甚至其它地方。</p> <p>那么如果使用直接调用 <code>window.localStorage</code> 的写法，需要替换项目中的所有 <code>localStorage</code> 调用，所以这里提取出一层，即 <code>model</code> 层，或者说是存储层。</p> <p>这样我们就不需要修改所有项目中的 <code>localStorage</code> 调用，只需要修改 <code>model</code> 层中的 <code>localStorage</code> 调用，将其改为 <code>cookie</code> 或者其它形式。</p> <p>这样保持我们调用方式不变：<code>getUserinfo</code>，同时还减小工作量，降低误差。</p> <p>在团队的分工合作中，负责这一层的团队成员直接从 <code>localStorage</code> 切换成 <code>cookie</code> 也不会对上层的团队成员造成影响。也就是我随意切换存储方式，不和任何人打招呼我自己也能完成，还不影响他们。</p> <p>而且独立出来以后我可以针对这一部分直接做单元测试，对项目的维护也有很大帮助。</p> <h2 id="每次页面跳转之前检测权限"><a href="#每次页面跳转之前检测权限" aria-hidden="true" class="header-anchor">#</a> 每次页面跳转之前检测权限</h2> <p>利用 vue-router 提供的守卫 <code>beforeEach</code>，在每次页面跳转之前检测当前用户权限，并进行处理。</p> <p><code>src/main.js</code> 中</p> <div class="language-js extra-class"><pre class="language-js"><code>router<span class="token punctuation">.</span><span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>to<span class="token punctuation">,</span> <span class="token keyword">from</span><span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> userInfo <span class="token operator">=</span> util<span class="token punctuation">.</span><span class="token function">getUserinfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> isLogin <span class="token operator">=</span> store<span class="token punctuation">.</span>state<span class="token punctuation">.</span>user<span class="token punctuation">.</span>login<span class="token punctuation">;</span>
    <span class="token keyword">let</span> notCheckLogin <span class="token operator">=</span> to<span class="token punctuation">.</span>matched<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span> record <span class="token operator">=&gt;</span> record<span class="token punctuation">.</span>meta<span class="token punctuation">.</span>notCheckLogin <span class="token punctuation">)</span>

    <span class="token comment">// 未登录，且需要检测登录状态的路由</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>userInfo <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isLogin <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>notCheckLogin<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">{</span> path<span class="token punctuation">:</span> <span class="token string">'/login'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>遇到这样一个问题，如图所示，代码无限循环执行：</p> <p><img src="https://raw.githubusercontent.com/Awesome-FE/exam-system-fe/master/note/beforeEach.png" alt="beforeEach"></p> <p>主要原因是判断条件不严谨，判断条件永远成立，导致死循环，这点需要注意。</p> <p>https://segmentfault.com/q/1010000014983955</p> <p>https://segmentfault.com/q/1010000012121359</p> <p>https://segmentfault.com/q/1010000012065855</p> <h2 id="其他"><a href="#其他" aria-hidden="true" class="header-anchor">#</a> 其他</h2> <p>理论上应该有一个接口用来更新用户状态，比如判断用户是否需要重新登录之类的，比如<code>api/refresh</code>， 所以逻辑应该是：</p> <p>用户进入app，判断本地是否有用户信息。</p> <ol><li><p>如果有，调用 <code>api/refresh</code>，判断是否需要重新登录。</p> <ol><li><p>不需要（连续登录），将信息保存在 vuex 中，并进入首页，往后数据读取全部走 vuex。</p></li> <li><p>需要（长时间未登录），删除本地用户信息并跳转到登录流程。</p></li></ol></li> <li><p>如果没有， 跳转到登录流程（以下是登录流程）。</p> <ol><li><p>调用 <code>api/login</code> 登录。</p></li> <li><p>将保存到本地，并保存到 vuex 中，往后数据读取全部走 vuex。</p></li></ol></li></ol></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/exam-system-fe/assets/js/5.0eac10a0.js" defer></script><script src="/exam-system-fe/assets/js/app.03fc6983.js" defer></script>
  </body>
</html>
